version: '3.4'

services:

  repository-cache:
    image: "redis:${repository.redis.server.version}"

  repository-database:
    image: "postgres:${repository.postgres.server.version}"
    command: ["postgres", "-c", "listen_addresses=*", "-c", "port=5432", "-c", "max_connections=300" ]
    environment:
      POSTGRES_DB: "${REPOSITORY_DATABASE_NAME:-repository}"
      POSTGRES_PASSWORD: "${REPOSITORY_DATABASE_PASS:-repository}"
      POSTGRES_USER: "${REPOSITORY_DATABASE_USER:-repository}"
    volumes:
      - "repository-database-volume:/var/lib/postgresql/data"

  repository-mailrelay:
    image: "freinet/postfix-relay:${repository.mail.relay.version}"
    environment:
      MAILNAME: "${REPOSITORY_MAILRELAY_MAILNAME:-127.0.0.1.xip.io}"
      RELAYHOST: "${REPOSITORY_MAILRELAY_RELAYHOST:-}"
    expose:
      - "25"
    volumes:
      - "repository-mailrelay-volume:/var/spool/postfix"

  repository-search-elastic:
    image: "docker.elastic.co/elasticsearch/elasticsearch:${repository.elasticsearch.server.version}"
    environment:
      - ES_JAVA_OPTS=-Xms${REPOSITORY_SEARCH_ELASTIC_JAVA_XMS:-1g} -Xmx${REPOSITORY_SEARCH_ELASTIC_JAVA_XMX:-1g}
      - discovery.type=single-node
    expose:
      - "9300"
    volumes:
      - "repository-search-elastic-volume:/usr/share/elasticsearch/data"

  repository-search-solr4:
    image: "${docker.registry}/${project.parent.artifactId}-build-search:${project.version}"
    command: ["catalina.sh", "run"]
    environment:
      CATALINA_OPTS: "-Xms${REPOSITORY_SEARCH_SOLR4_JAVA_XMS:-1g} -Xmx${REPOSITORY_SEARCH_SOLR4_JAVA_XMX:-1g}"
      MY_HOST_INTERN: repository-search-solr4
      MY_PORT_INTERN: "8080"
      REPOSITORY_SERVICE_HOST: repository-service
      REPOSITORY_SERVICE_PORT: "8080"
    volumes:
      - "repository-search-solr4-volume:/opt/alfresco/alf_data"
    depends_on:
      - repository-service

  repository-service:
    image: "${docker.registry}/${project.parent.artifactId}-build-service:${project.version}"
    command: ["catalina.sh", "run"]
    environment:
      CATALINA_OPTS: "-Xms${REPOSITORY_SERVICE_JAVA_XMS:-1g} -Xmx${REPOSITORY_SERVICE_JAVA_XMX:-1g}"
      MY_HOME_APPID: "${COMPOSE_PROJECT_NAME:-deploy}"
      MY_HOST_EXTERN: "${REPOSITORY_SERVICE_HOST:-repository.127.0.0.1.xip.io}"
      MY_HOST_INTERN: repository-service
      MY_PORT_EXTERN: "${REPOSITORY_SERVICE_PORT_HTTP:-8100}"
      MY_PORT_INTERN: "8080"
      MY_ROOT_PASS: "${REPOSITORY_SERVICE_ROOT_PASS:-admin}"
      MY_SMTP_AUTH: "${REPOSITORY_SERVICE_SMTP_AUTH:-}"
      MY_SMTP_FROM: "${REPOSITORY_SERVICE_SMTP_FROM:-noreply@127.0.0.1.xip.io}"
      MY_SMTP_HOST: "${REPOSITORY_SERVICE_SMTP_HOST:-repository-mailrelay}"
      MY_SMTP_PASS: "${REPOSITORY_SERVICE_SMTP_PASS:-}"
      MY_SMTP_PORT: "${REPOSITORY_SERVICE_SMTP_PORT:-25}"
      MY_SMTP_REPL: "${REPOSITORY_SERVICE_SMTP_REPL:-false}"
      MY_SMTP_USER: "${REPOSITORY_SERVICE_SMTP_USER:-}"
      REPOSITORY_CACHE_HOST: repository-cache
      REPOSITORY_CACHE_PORT: "6379"
      REPOSITORY_DATABASE_HOST: repository-database
      REPOSITORY_DATABASE_NAME: "${REPOSITORY_DATABASE_NAME:-repository}"
      REPOSITORY_DATABASE_PASS: "${REPOSITORY_DATABASE_PASS:-repository}"
      REPOSITORY_DATABASE_PORT: "5432"
      REPOSITORY_DATABASE_USER: "${REPOSITORY_DATABASE_USER:-repository}"
      REPOSITORY_SEARCH_ELASTIC_HOST: repository-search-elastic
      REPOSITORY_SEARCH_ELASTIC_PORT: "9200"
      REPOSITORY_SEARCH_SOLR4_HOST: repository-search-solr4
      REPOSITORY_SEARCH_SOLR4_PORT: "8080"
      REPOSITORY_TRANSFORM_HOST: repository-transform
      REPOSITORY_TRANSFORM_PORT: "8100"
    expose:
      - "8080"
    ports:
      - "${COMMON_BIND_HOST:-127.0.0.1}:${REPOSITORY_SERVICE_PORT_HTTP:-8100}:8081"
    volumes:
      - "repository-service-volume-data:/opt/alfresco/alf_data"
      - "repository-service-volume-shared:/usr/local/tomcat/shared"
    depends_on:
      - repository-cache
      - repository-database
      - repository-mailrelay
      - repository-search-elastic
      - repository-transform

  repository-transform:
    image: "${docker.registry}/${project.parent.artifactId}-build-transform:${project.version}"
    expose:
      - "8100"

volumes:
  repository-database-volume:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-database-volume"
    external: true
  repository-mailrelay-volume:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-mailrelay-volume"
    external: true
  repository-search-elastic-volume:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-search-elastic-volume"
    external: true
  repository-search-solr4-volume:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-search-solr4-volume"
    external: true
  repository-service-volume-data:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-service-volume-data"
    external: true
  repository-service-volume-shared:
    name: "${COMPOSE_PROJECT_NAME:-deploy}_repository-service-volume-shared"
    external: true